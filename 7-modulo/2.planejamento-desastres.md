# Planejamento para desastres

Depois de confiabilidade, nosso tema é plano de recuperação de desastres. Para aumentar a disponibilidade, fazemos implantações em várias zonas de uma região. No Compute Engine, um grupo de instâncias regionais oferece funcionalidade integrada e mantém as instâncias operando, o que garante a alta disponibilidade.

Divida a carga com balanceamento, use recuperação automática e um app de verificação de integridade. A alta disponibilidade dos dados depende dos requisitos da solução de armazenamento. No Cloud SQL, você configura o banco de dados para alta disponibilidade, garantindo redundância e uma instância de espera do servidor de banco de dados em outra zona.

Alguns serviços de dados, como o Firestore e o Spanner, oferecem alta disponibilidade por padrão. No exemplo anterior, o grupo gerenciado de instâncias regionais distribui as VMs nas zonas. Ao criar um grupo de instâncias, você escolhe a configuração de uma ou várias zonas ou regional. Também é possível implantar os clusters do GKE em uma ou várias zonas. O cluster é composto de um controlador mestre e um conjunto de nós. Os clusters regionais replicam o cluster mestre e os nós em várias zonas de uma região para aumentar a disponibilidade.

Se você usa grupos de instâncias no seu serviço, crie uma verificação de integridade para ativar a recuperação automática. A verificação é um endpoint de teste no serviço. Ela indica se o serviço está disponível e pronto para aceitar solicitações e se está em execução. Se você usa outros serviços de back-end, verifique a disponibilidade deles antes de criar o endpoint de verificação de integridade para ter certeza de que o serviço vai ser executado. Se ele depende de outros serviços que estão indisponíveis, também não vai ficar disponível. Se alguma instância do grupo falha na verificação de integridade, ela é substituída por uma nova.

Com a verificação de integridade, os balanceadores de carga identificam a quais instâncias podem enviar solicitações. Vamos ver como garantir alta disponibilidade aos serviços do Google Cloud de armazenamento e banco de dados. No Google Cloud Storage, use buckets de armazenamento em várias regiões para aumentar a disponibilidade se a latência é insignificante. A disponibilidade do bucket multirregional é um fator de dois, porque a indisponibilidade diminui de 0,1% para 0,5%.

Se você está usando o Cloud SQL e precisa de alta disponibilidade, crie uma réplica de failover. O Firestore e o Spanner oferecem opções de implantação em uma ou várias regiões. A multirregião fica localizada em uma área geográfica geral, como os Estados Unidos. Os dados localizados em uma multirregião são replicados em várias regiões. Nessa região, os dados são replicados em zonas. Os locais multirregionais podem suportar a perda de regiões inteiras e permanecer disponíveis sem perder dados. As configurações dos locais multirregionais do Firestore e do Spanner oferecem disponibilidade de 99,999%. Em um ano, são menos de seis minutos de inatividade.

Mas não se esqueça: implantações para aumentar a disponibilidade geram custos porque usam mais recursos. Ao desenvolver um projeto, é importante avaliar os custos das suas escolhas relacionadas à arquitetura. Além de calcular o custo dos recursos usados, considere o custo da inatividade do serviço.

Agora vamos ver estratégias de recuperação de desastres. O uso de espera passiva é uma estratégia simples de recuperação de desastres. Basta criar snapshots de imagens do disco permanente, imagens de máquina e backup de dados e armazenar tudo isso em um local multirregional. Você pode, por exemplo, capturar snapshots para o caso de precisar recriar o sistema. Se a região principal falha, você ativa serviços na região de backup usando as imagens do snapshot e discos permanentes. E depois direciona as solicitações para a nova região. E não deixe de documentar e testar o procedimento de recuperação com frequência.

Outra estratégia de recuperação de desastres é ter uma espera ativa, com grupos de instâncias em várias regiões e um balanceador de carga global para direcionar o tráfego. Este diagrama mostra essa configuração. Também podemos usar essa estratégia em serviços de armazenamento de dados, como buckets multirregionais do Cloud Storage, e em serviços de banco de dados, como o Firestore e o Spanner. Mas saiba que todo plano de recuperação de desastres precisa considerar duas métricas: objetivo do ponto de recuperação e objetivo do tempo de recuperação. A primeira métrica define a quantidade de dados que podem ser perdidos, e a segunda métrica define o tempo que um serviço pode levar para voltar a funcionar.

Imagine cenários que possam provocar a perda de dados ou a falha de serviços e depois crie uma tabela como a do slide. Isso pode ajudar você a projetar cenários diferentes e a identificar prioridades. Na atividade de design, você vai criar essa tabela e um plano de recuperação de desastres. Crie um plano de recuperação de acordo com cada cenário de desastre que você imaginou. Defina uma estratégia para cada cenário com base nos riscos e nos objetivos de ponto e tempo de recuperação.

Depois de documentar, não deixe a sua estratégia de lado. Compartilhe o processo de recuperação de falha a todas as partes. Procure testar e validar os processos com frequência, ao menos uma vez por ano. Assim a recuperação se torna parte da rotina, e o processo fica mais simples. A tabela mostra a estratégia de backup de recursos diferentes, o local do backup e o procedimento de recuperação. Essa visualização simples ilustra as informações que é preciso coletar. Antes da próxima atividade de design, repito que é importante treinar a equipe para encarar possíveis desastres. Você já sabe que falhas o seu sistema pode apresentar? Pense em planos para resolver esses problemas e documente tudo. Depois coloque os planos em prática em um teste ou ambiente de produção. Em cada fase, analise os riscos com atenção e compare os custos da alta disponibilidade com o custo da indisponibilidade. O último vai ajudar você a avaliar o risco de não conhecer os pontos fracos do sistema.