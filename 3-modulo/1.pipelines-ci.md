# Pipelines de integração contínua

Vamos começar pelos pipelines de integração contínua. Os pipelines de integração contínua automatizam a compilação de aplicativos. Este gráfico é uma representação simplista de um pipeline, que pode ser personalizado para atender aos seus requisitos. O processo começa com o check-in do código em um repositório onde os testes de unidade serão executados. Se os testes forem aprovados, um pacote de implantação será criado como uma imagem do Docker. Essa imagem é salva em um Container Registry para ser implantada. Cada microsserviço deve ter o próprio repositório. As etapas adicionais comuns incluem inspeção do código, análise de qualidade usando ferramentas, como o SonarQube, testes de integração, geração de relatórios de testes e verificação de imagem. O Google Cloud tem os componentes necessários para criar um pipeline de integração contínua. Vamos ver cada um.

O serviço Cloud Source Repositories oferece repositórios Git privados, que estão hospedados no Google Cloud. Esses repositórios permitem desenvolver e implantar um app ou serviço em um espaço que oferece colaboração e controle de versões do código. O Cloud Source Repositories é integrado ao Google Cloud, para uma experiência perfeita do desenvolvedor.

O Cloud Build executa seus builds na infraestrutura do Google Cloud. Ele pode importar o código-fonte do Cloud Storage, Cloud Source Repositories, GitHub ou Bitbucket, executar um build de acordo com as especificações e produzir artefatos, como contêineres do Docker ou arquivos Java. O Cloud Build executa o build como uma série de etapas de compilação. Cada uma delas ocorre em um contêiner do Docker. A etapa permite as mesmas ações realizadas em um contêiner, qualquer que seja o ambiente. Você pode manter as etapas padrão ou definir outras.

Um gatilho do Cloud Build inicia uma compilação automaticamente quando o código-fonte é alterado. Você pode configurar o gatilho para compilar o código quando alguma alteração for feita no repositório de origem ou só nas mudanças que corresponderem a critérios específicos.

O Container Registry é um local para a equipe gerenciar imagens do Docker ou pacotes de implantação, fazer análises de vulnerabilidade e definir quem acessará quais componentes com controle de acesso avançado. Vamos ver cada um desses serviços em mais detalhes.

O Cloud Source Repositories oferece repositórios Git gerenciados. É possível usar o Cloud IAM para adicionar membros da equipe ao projeto e conceder a eles permissões para criar, visualizar e atualizar repositórios. É possível configurar os repositórios para publicar mensagens em um tópico especificado do Pub/Sub. Mensagens podem ser publicadas quando um usuário cria ou exclui um repositório ou envia uma confirmação. O Cloud Source Repositories tem outros recursos, como depuração na produção usando o Cloud Debugger, geração de registros sobre quando, onde e quais ações foram realizadas e implantação direta no App Engine. Também é possível conectar um repositório GitHub ou Bitbucket ao Cloud Source Repositories. Os repositórios conectados são sincronizados automaticamente com o Cloud Source Repositories.

O Cloud Build permite criar software rapidamente em todas as linguagens. É um serviço de criação do Docker hospedado no Google e uma alternativa ao uso do comando docker build. A CLI pode ser usada para enviar um build com o gcloud. Veja um exemplo neste slide. "gcloud build submits" envia o build, que será executado como remoto. “--tag” indica a tag usada na criação da imagem. A tag precisa ter o namespace gcr.io ou .gcr.io.. A origem deve conter um Dockerfile se você usar a tag. Por fim, o ponto representa o local da origem da compilação.

Os gatilhos de compilação monitoram um repositório e criam um contêiner sempre que um código é enviado. Os gatilhos de compilação do Google podem ser usados com Maven, Cloud Build e Docker. Um gatilho do Cloud Build inicia uma compilação automaticamente quando o código-fonte é alterado. Ele pode ser configurado para iniciar uma compilação na confirmação para uma determinada ramificação ou que contém uma tag específica. É possível definir uma expressão regular para uma ramificação ou um valor de tag. A configuração do build pode ser definida em um Dockerfile ou arquivo do Cloud Build. Veja as configurações necessárias neste slide. Primeiro selecione a origem, que pode ser o Cloud Source Repositories, o GitHub ou o Bitbucket. Depois, selecione um repositório de origem e as configurações do gatilho. Elas indicam a ramificação ou a tag a ser usada e a configuração do build, como o Dockerfile ou o arquivo do Cloud Build.

O Container Registry é um repositório do Docker hospedado pelo Google Cloud. As imagens criadas com o Cloud Build são salvas automaticamente no Container Registry. Elas têm um prefixo, como mostra o slide. Também é possível enviar e extrair imagens usando os comandos padrão do Docker. Para enviar uma imagem, use: docker push gcr.io/your-project-id/image-name. Para extrair uma imagem, use: docker pull gcr.io/your-project-id/image-name. Com a autorização binária, apenas contêineres confiáveis podem ser implantados no GKE. A autorização binária é um serviço do Google Cloud baseado na especificação do Kritis Signer. Para que o serviço funcione, é necessário ativar a autorização binária no cluster do GKE onde a implantação será feita. É necessária uma política para assinar as imagens. Quando uma imagem é criada pelo Cloud Build, um atestador verifica que ela veio de um repositório confiável, como o Source Repositories. O Container Registry inclui uma verificação de vulnerabilidades que analisa os contêineres. O diagrama mostra um fluxo de trabalho comum. A inclusão de código aciona o gatilho de compilação do Cloud Build. Como parte da compilação, o Container Registry vai fazer uma verificação de vulnerabilidades assim que uma nova imagem for adicionada por upload. O mecanismo de verificação publica mensagens no Pub/Sub. O Kritis Signer detecta notificações do Pub/Sub do mecanismo de verificação de vulnerabilidades do Container Registry e gera um atestado se a imagem for aprovada na verificação. Depois o serviço de autorização binária do Google Cloud aplica a política que exige os atestados do Kritis Signer para implantar uma imagem de contêiner. Esse fluxo impede a implantação de imagens com vulnerabilidades abaixo de um limite determinado.